# This will run on Travis' 'new' container-based infrastructure
sudo: true

# Setup for Ubuntu Bionic (18.04)
dist: bionic

# Environment variables
env:
  global:
    - PACKAGE_DIR: $HOME/packages
    - VERSION: 1.1.1

# Install dependencies
addons:
  apt:
    packages:
      - debhelper
      - dkms
      - fakeroot

stages:
    - name: deploy_tag
      #if: tag IS present

# Generate and deploy documentation
jobs:
  include:
    - &deploy-dkms-stage
      stage: deploy_tag
      name: "Deploy Data Dev"
      env:
        - MODULE=datadev
        - MODULE_DIR=data_dev/driver
        - DEST_DIR=/usr/src/$MODULE-$VERSION
      before_script:
        - sudo mkdir $DEST_DIR
        - sudo mkdir $DEST_DIR/src
        - sudo cp $MODULE_DIR/src/* $DEST_DIR/src
        - sudo cp $MODULE_DIR/Makefile $DEST_DIR
        - sudo cp $MODULE_DIR/dkms.conf $DEST_DIR
        - sudo echo "PACKAGE_VERSION=$VERSION" | sudo tee -a $DEST_DIR/dkms.conf
      script:
        - sudo dkms mkdeb -m $MODULE -v $VERSION --source-only
      after_success:
        # Upload conda package
        #- anaconda -t $CONDA_UPLOAD_TOKEN_TAG upload bld-dir/`echo $TRAVIS_OS_NAME`-64/*.tar.bz2

    # - <<: *deploy-conda-stage   # Conda for MacOS
    #os: osx
    #language: ruby  # osx does not support language=python

